<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thoth</title>
    <meta name="description" content="Thoth-Agent resources graphs.">
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<body>
<div class="chart-container" style="position: relative; height:720px; width:1280px">
    <canvas id="cpu-chart"></canvas>
</div>
<div class="chart-container" style="position: relative; height:360px; width:360px">
    <canvas id="memory-chart"></canvas>
</div>
<div class="chart-container" style="position: relative; height:360px; width:360px">
    <canvas id="disk-chart"></canvas>
</div>
<script>
    async function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getResources() {
        const response = await fetch("http://localhost:11805/resource-usage")
        return await response.json()
    }

    async function loop() {
        // COMMON LABELS
        const chartLabels = []

        // CPU CHART
        const cpuChart = new Chart(document.getElementById('cpu-chart').getContext('2d'), {
                options: {
                    scales: {
                        y: {
                            display: true,
                            min: 0,
                            max: 100,
                        }
                    }
                },
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            data: [0],
                            label: "Consumed CPU",
                            borderColor: "#E40830",
                            fill: false
                        }
                    ]
                },
            }
        );

        // MEMORY CHART
        const memoryChart = new Chart(document.getElementById('memory-chart').getContext('2d'), {
            type: "bar",
            options: {
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true
                    }
                }
            },
            data: {
                labels: ['Memory'],
                datasets: [
                    {
                        data: [],
                        label: "Memory Used",
                        backgroundColor: 'rgb(255, 0, 0)',
                        borderWidth: 1
                    },
                    {
                        data: [],
                        label: "Memory Available",
                        backgroundColor: 'rgb(0, 255, 0)',
                        borderWidth: 1
                    }
                ],
            }
        })

        // DISK CHART
        const diskChart = new Chart(document.getElementById('disk-chart').getContext('2d'), {
            type: "doughnut",
            data: {
                labels: [
                    'Used Disk',
                    'Free Disk',
                ],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgb(210, 50, 180)',
                        'rgb(150, 150, 150)',
                    ],
                    hoverOffset: 4
                }]
            }
        })

        while (true) {
            const resources = await getResources()
            const iterations = 60

            // COMMON LABELS
            if (chartLabels.length === iterations) {
                chartLabels.shift()
            }
            chartLabels.push(resources.date)

            // CPU
            if (cpuChart.data.datasets[0].data.length === iterations) {
                // append new element at end of the array and remove the first one
                cpuChart.data.datasets[0].data.shift()
            }
            cpuChart.data.datasets[0].data.push(resources.cpu.UsedPercentage)

            // MEMORY
            memoryChart.data.datasets[0].data[0] = resources.memory.UsedMemory
            memoryChart.data.datasets[1].data[0] = resources.memory.AvailableMemory

            // DISK
            diskChart.data.datasets[0].data[0] = resources.disk.UsedSpace
            diskChart.data.datasets[0].data[1] = resources.disk.AvailableSpace

            // UPDATE
            cpuChart.update()
            memoryChart.update()
            diskChart.update()

            await sleep(1000)
        }
    }

    loop()
</script>
</html>